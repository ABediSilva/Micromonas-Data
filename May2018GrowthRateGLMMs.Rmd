---
title: "May2018LightExperiment"
author: "Anamica Bedi de Silva"
date: "5/24/2018"
output: html_document
---
####Reading in  Plate Reader Data
```{r, warning=FALSE, echo=FALSE}
rm(list=ls())

library(readxl)
library(lubridate)
library(ggplot2)
library(glmmTMB)
library(sjPlot)
library(lattice)
library(lme4)
library(effects)
library(lmerTest)
library(stringr)

setwd('')

#Read in plate reader and strain metadata
db <- read.csv('May2018GrowthData.csv')
```

```{r, echo=F}
##Creating high light data frame
high<-subset(db, Light=="high")

##Adding column with YYYY-MM-DD format, not YYYY-MM-DD-HH-MM-SS
days<-unique(high$short.date) 

##finding mean of blanks from each day to subtract from RFU data
for (i in 1:length(days)){
  dates<-subset(high, short.date==days[i])
  blanks<-subset(dates, SampleID=="blank")
  blanks<-subset(blanks, !(RFU>40))
  mean.b<-mean(blanks$RFU)
  high$bRFU<-(high$RFU-mean.b)
  
} 

#Excluding negative numbers
high<-subset(high, !(bRFU<=0)) 

#Reading in data with dates for exponential phase growth
hi.dates<-read.csv('/Users/nankabd/Desktop/May2018LightExperimentInfo/hidatelist.csv') #dates of exponential growth for each curve

#Subset of reading from second transfer. If you don't change to HST then it's in universal time is used and that's a mess
hi.dates$T2.start<-mdy(hi.dates$T2.start, tz="HST") 
hi.dates$T2.end<-mdy(hi.dates$T2.end, tz="HST")
hour(hi.dates$T2.start)<-1
hour(hi.dates$T2.end)<-23

hi.dates$T3.start<-mdy(hi.dates$T3.start, tz="HST")
hi.dates$T3.end<-mdy(hi.dates$T3.end, tz="HST")
hour(hi.dates$T3.start)<-1
hour(hi.dates$T3.end)<-23

hi.dates$T4.start<-mdy(hi.dates$T4.start, tz="HST")
hi.dates$T4.end<-mdy(hi.dates$T4.end, tz="HST")
hour(hi.dates$T4.start)<-1
hour(hi.dates$T4.end)<-23

##Creating low light data frame. Uses steps as above for high light data frame.
low<-subset(db, Light=="low")

days<-unique(low$short.date)

for (i in 1:length(days)){
  dates<-subset(low, short.date==days[i])
  blanks<-subset(dates, SampleID=="blank")
  blanks<-subset(blanks, !(RFU>40))
  mean.b<-mean(blanks$RFU)
  low$bRFU<-(low$RFU-mean.b)
  
}

low<-subset(low, !(bRFU<=0))

lo.dates<-read.csv('/Users/nankabd/Desktop/May2018LightExperimentInfo/lodatelist.csv')

lo.dates$T2.start<-mdy(lo.dates$start.T2, tz="HST")
lo.dates$T2.end<-mdy(lo.dates$end.T2, tz="HST")
hour(lo.dates$T2.start)<-1
hour(lo.dates$T2.end)<-23

lo.dates$T3.start<-mdy(lo.dates$start.T3, tz="HST")
lo.dates$T3.end<-mdy(lo.dates$end.T3, tz="HST")
hour(lo.dates$T3.start)<-1
hour(lo.dates$T3.end)<-23

```

###Subsetting based on Transfer
```{r, echo=F}
hiT2<-subset(high,Transfer=="T2")
hiT2.dates<-data.frame("ID.plate"=hi.dates$ID.plate, "start"= hi.dates$T2.start, "end"=hi.dates$T2.end)

hiT3<-subset(high,Transfer=="T3")
hiT3.dates<-data.frame("ID.plate"=hi.dates$ID.plate, "start"= hi.dates$T3.start, "end"=hi.dates$T3.end)

hiT4<-subset(high, Transfer=="T4")
hiT4.dates<-data.frame("ID.plate"=hi.dates$ID.plate, "start"= hi.dates$T4.start, "end"=hi.dates$T4.end)

hi.all.T<-subset(high, !(Transfer=="T1"))

lowT2<-subset(low,Transfer=="T2")
lowT2.dates<-data.frame("ID.plate"=lo.dates$ID.plate, "start"= lo.dates$T2.start, "end"=lo.dates$T2.end)

lowT3<-subset(low,Transfer=="T3")
lowT3.dates<-data.frame("ID.plate"=lo.dates$ID.plate, "start"= lo.dates$T3.start, "end"=lo.dates$T3.end)

```
####Defining Function for Regression and Plotting Loop

```{r, echo=F}
loops<-function(x, y){ 
par(mfrow=c(4,3), mar=c(4,3,1,0))
host<-vector()
virus<-vector()
cross<-vector()
resist<-vector()
transfer<-vector()
plate.name<-vector()
light<-vector()
reg<-vector()
isolate<-vector()
reg<-vector()
sampleid<-vector()
isolate<-vector()
spec.isolate<-vector()
max.rfu<-vector()
Names<-unique(x$newID.plate)

  for(i in 1:length(Names)){
    sub.samp<-subset(x, newID.plate==Names[i]) #ID.plate==Names[i]
    sub.samp<-merge(sub.samp, y)
    if (is.na(sub.samp$start[1])) next
  
    sub.date<-subset(sub.samp, sub.samp$start <= sub.samp$date & sub.samp$date<=sub.samp$end)
    
    plot(bRFU~date, sub.date, type='b', main=Names[i], las=2, log='y')
    reg[i]<-coef(lm(log(bRFU) ~ date, sub.date))[2]
    
    host[i]<-as.character(sub.date$newHost[1])
    virus[i]<-as.character(sub.date$newVirus[1])
    cross[i]<-as.character(sub.date$newCross[1])
    resist[i]<-as.character(sub.date$Resistance[1])
    transfer[i]<-as.character(sub.date$Transfer[1])
    plate.name[i]<-as.character(sub.date$Plate[1])
    light[i]<-as.character(sub.date$Light[1])
    spec.isolate[i]<-as.character(sub.date$newIDs[1])
    isolate[i]<-substr(sub.date$newIDs, 1, nchar(as.character(sub.date$newIDs))-1)
    sampleid[i]<-as.character(sub.date$newID.plate[1])
    max.rfu[i]<-max(sub.date$bRFU)
}

slope<-reg*(24*3600)

all.dat<-data.frame(sampleid,spec.isolate, host, virus, cross, resist, transfer, plate.name, light, slope, isolate, max.rfu)
all.dat$virus<-as.character(all.dat$virus)
all.dat$virus[is.na(all.dat$virus)]<-"None"
return(all.dat)
}

```
###High Growth Rate Data Frames
```{r, warning=F, echo=F}

hiT2.loops<-loops(hiT2, hiT2.dates)

hiT3.loops<-loops(hiT3, hiT3.dates)

hiT4.loops<-loops(hiT4, hiT4.dates)

hi.all.loops<-rbind(hiT2.loops, hiT3.loops, hiT4.loops)

```
###Low Growth Rate Data Frames
```{r, warning=F, echo=F}
loT2.loops<-loops(lowT2, lowT2.dates)

loT3.loops<-loops(lowT3, lowT3.dates)

lo.all.loops<-rbind(loT2.loops,loT3.loops)

all.loops<-rbind(hi.all.loops, lo.all.loops)
```

###Prepping data frames for generalized mixed models by dropping blanks
```{r}
no.blanks<-subset(all.loops, cross!="blank")
no.blanks<-na.omit(no.blanks)
no.blanks$cross<-no.blanks$cross[,drop=T]
```

#Generalized mixed models
##For M1 (FL13)
```{r}
##Main data frame, including high and low light
big.buddy = subset(no.blanks, host=="M1")

##Model with interaction term
tmb.mod = glmmTMB(slope ~ resist*light + (1|plate.name) + (1|spec.isolate), dispformula =~ resist, data=big.buddy)

##Model with no interaction term
tmb.noint  = glmmTMB(slope ~ resist + light + (1|plate.name) + (1|spec.isolate), dispformula =~ resist, data=big.buddy)

#interaction performs better
anova(tmb.mod, tmb.noint) 

#plotting random effects
plot_model(tmb.mod, type="re")

#running models by host-virus cross
x.13<-c("M1V3", "M1V2", "M1V1")
par(mfrow=c(2,3))
for (i in 1:length(x.13)){
  x.sub<-subset(no.blanks, cross==x.13[i])
  x.13s<-subset(no.blanks, cross=="M1S")
  x.13df<-rbind(x.sub, x.13s)
  x.mm<-glmmTMB(slope ~ resist*light + (1|plate.name) + (1|spec.isolate), dispformula =~ resist, data=x.13df)
  mean.CIs<-allEffects(x.mm)[[1]]
  
  plot(allEffects(x.mm), main=paste(x.13[i]))
  plot_model(x.mm, type="re")
}
```

##For FL42 (M2)
```{r}
big.buddy = subset(no.blanks, host=="M2")

##Model with interaction term
tmb.mod = glmmTMB(slope ~ resist*light + (1|plate.name) + (1|spec.isolate), dispformula =~ resist, data=big.buddy)

##Model with no interaction term
tmb.noint  = glmmTMB(slope ~ resist + light + (1|plate.name) + (1|spec.isolate), dispformula =~ resist, data=big.buddy)

#model with interaction performs better
anova(tmb.mod, tmb.noint)

#plots of random effects
plot_model(tmb.mod, type="re")

#running models by host-virus cross
x.42<-c("M2V4", "M2V3", "M2V2")

par(mfrow=c(2,3))
for (i in 1:length(x.42)){
  x.sub<-subset(no.blanks, cross==x.42[i])
  x.42s<-subset(no.blanks, cross=="M2S")
  x.42df<-rbind(x.sub, x.42s)
  
  x.mm<-glmmTMB(slope ~ resist*light + (1|plate.name) + (1|isolate), dispformula =~ resist, data=x.42df)
  mean.CIs<-allEffects(x.mm)[[1]]
  
  plot(allEffects(x.mm), main=paste(x.42[i]))
  plot_model(x.mm, type="re") 
}
  
```
